' ========================================
' Module5 (完全修正版)
' タイプ: 標準モジュール
' 修正日時: 2025-11-17
' ========================================

Option Explicit

' *************************************************************
' モジュール：勤怠入力漏れ検出（完全修正版）
' 目的：勤怠入力漏れと申請矛盾を検出する
' Copyright (c) 2025 SI1 shunpei.suzuki
'
' 改版履歴：
' 2025/04/02 module2から分割作成
' 2025/04/04 お昼休憩時間の矛盾チェック機能追加
' 2025/04/05 お昼休憩時間（退勤）の矛盾チェックロジック修正
' 2025/11/17 矛盾検出と漏れ検出の処理フロー完全分離（v3.0）
' *************************************************************

' 定数定義
Private Const COL_EMPLOYEE_ID As Integer = 1
Private Const COL_EMPLOYEE_NAME As Integer = 2
Private Const COL_DATE As Integer = 3
Private Const COL_DAY_TYPE As Integer = 4
Private Const COL_LEAVE_TYPE As Integer = 5
Private Const COL_MISSING_ENTRY_TYPE As Integer = 6
Private Const COL_COMMENT As Integer = 7
Private Const COL_ATTENDANCE_TIME As Integer = 8
Private Const COL_DEPARTURE_TIME As Integer = 9
Private Const COL_CONTRADICTION_TYPE As Integer = 10
Private Const DEBUG_MODE As Boolean = False

' ハイライト色定義
Private Const COLOR_CONTRADICTION As Long = 16750848  ' オレンジ RGB(255, 200, 150)
Private Const COLOR_MISSING As Long = 16764108        ' 赤 RGB(255, 200, 200)

' グローバル変数の参照
' Public g_IncludeToday As Boolean (module2_coreで定義)

' *************************************************************
' 関数名: DetectMissingEntries
' 目的: 勤怠入力漏れと申請矛盾を検出（完全修正版）
' 処理フロー:
'   1. 矛盾検出（午前有休・午後有休・お昼休憩時間）
'   2. 矛盾がないレコードのみ勤怠漏れ検出
'   3. 結果に応じて適切な色でハイライト
' *************************************************************
Public Sub DetectMissingEntries(wsCSVData As Worksheet, outputSheet As Worksheet)
    Dim includeToday As Boolean
    includeToday = g_IncludeToday
    
    If DEBUG_MODE Then
        Debug.Print "=== 勤怠入力漏れ・矛盾検出開始 ==="
        Debug.Print "当日分を含める設定: " & includeToday
    End If
    
    On Error GoTo ErrorHandler
    
    Application.StatusBar = "勤怠入力漏れ・矛盾を検出しています..."
    
    ' 最終行を取得
    Dim lastRow As Long
    lastRow = wsCSVData.Cells(wsCSVData.Rows.Count, "A").End(xlUp).Row
    
    If lastRow <= 1 Then
        MsgBox "CSVデータが存在しません。", vbExclamation
        Exit Sub
    End If
    
    ' 列インデックスの特定
    Dim colIndex As Object
    Set colIndex = GetColumnIndexes(wsCSVData)
    
    If colIndex Is Nothing Then
        Exit Sub
    End If
    
    ' データを配列に読み込み（高速化）
    Dim dataArray As Variant
    dataArray = wsCSVData.Range(wsCSVData.Cells(2, 1), _
                                wsCSVData.Cells(lastRow, wsCSVData.Cells(1, wsCSVData.Columns.Count).End(xlToLeft).Column)).Value
    
    ' 社員辞書（重複カウント用）
    Dim employeeDict As Object
    Set employeeDict = CreateObject("Scripting.Dictionary")
    
    ' 統計カウンター
    Dim totalMissingCount As Long
    Dim missingAttendanceCount As Long
    Dim missingDepartureCount As Long
    Dim missingBothCount As Long
    Dim contradictionCount As Long
    
    totalMissingCount = 0
    missingAttendanceCount = 0
    missingDepartureCount = 0
    missingBothCount = 0
    contradictionCount = 0
    
    Dim outputRow As Long
    outputRow = 2
    
    ' 各レコードを処理
    Dim i As Long
    For i = 1 To UBound(dataArray, 1)
        ' 基本情報の取得
        Dim employeeID As String
        Dim employeeName As String
        Dim entryDate As Date
        Dim dayType As String
        Dim deliveryContent As String
        Dim attendanceTime As String
        Dim departureTime As String
        
' 基本情報の取得
employeeID = Trim(CStr(dataArray(i, colIndex("社員番号"))))
employeeName = Trim(CStr(dataArray(i, colIndex("氏名"))))

' 日付の変換
On Error Resume Next
entryDate = CDate(dataArray(i, colIndex("日付")))
On Error GoTo ErrorHandler

dayType = Trim(CStr(dataArray(i, colIndex("カレンダー"))))
deliveryContent = Trim(CStr(dataArray(i, colIndex("届出内容"))))
attendanceTime = Trim(CStr(dataArray(i, colIndex("出社"))))      ' 修正
departureTime = Trim(CStr(dataArray(i, colIndex("退社"))))       ' 修正
        ' 勤怠入力が必要かどうかを判定
        If Not IsEntryRequired(dayType, deliveryContent) Then
            GoTo NextRow
        End If
        
        ' === 第1段階：矛盾検出 ===
        Dim contradictionResult As Variant
        contradictionResult = CheckContradiction(deliveryContent, attendanceTime, departureTime)
        
        If contradictionResult(0) Then
            ' 矛盾あり → オレンジでハイライト
            If Not employeeDict.Exists(employeeID) Then
                employeeDict.Add employeeID, employeeName
            End If
            
            With outputSheet
                .Cells(outputRow, COL_EMPLOYEE_ID).Value = employeeID
                .Cells(outputRow, COL_EMPLOYEE_NAME).Value = employeeName
                .Cells(outputRow, COL_DATE).Value = entryDate
                .Cells(outputRow, COL_DAY_TYPE).Value = dayType
                .Cells(outputRow, COL_LEAVE_TYPE).Value = deliveryContent
                .Cells(outputRow, COL_MISSING_ENTRY_TYPE).Value = ""
                .Cells(outputRow, COL_COMMENT).Value = contradictionResult(1)
                
                ' 時刻列の設定
                .Cells(outputRow, COL_ATTENDANCE_TIME).Value = attendanceTime
                .Cells(outputRow, COL_ATTENDANCE_TIME).NumberFormat = "h:mm"
                .Cells(outputRow, COL_DEPARTURE_TIME).Value = departureTime
                .Cells(outputRow, COL_DEPARTURE_TIME).NumberFormat = "h:mm"
                
                ' オレンジでハイライト
                .Range(.Cells(outputRow, 1), .Cells(outputRow, COL_DEPARTURE_TIME)).Interior.Color = COLOR_CONTRADICTION
            End With
            
            outputRow = outputRow + 1
            contradictionCount = contradictionCount + 1
            totalMissingCount = totalMissingCount + 1
            
        Else
            ' === 第2段階：矛盾がない場合のみ勤怠漏れ検出 ===
            Dim missingResult As Variant
            missingResult = CheckMissingEntry(attendanceTime, departureTime)
            
            If missingResult(0) Then
                ' 勤怠漏れあり → 赤でハイライト
                If Not employeeDict.Exists(employeeID) Then
                    employeeDict.Add employeeID, employeeName
                End If
                
                With outputSheet
                    .Cells(outputRow, COL_EMPLOYEE_ID).Value = employeeID
                    .Cells(outputRow, COL_EMPLOYEE_NAME).Value = employeeName
                    .Cells(outputRow, COL_DATE).Value = entryDate
                    .Cells(outputRow, COL_DAY_TYPE).Value = dayType
                    .Cells(outputRow, COL_LEAVE_TYPE).Value = deliveryContent
                    .Cells(outputRow, COL_MISSING_ENTRY_TYPE).Value = missingResult(1)
                    .Cells(outputRow, COL_COMMENT).Value = missingResult(2)
                    
                    ' 時刻列の設定
                    .Cells(outputRow, COL_ATTENDANCE_TIME).Value = attendanceTime
                    .Cells(outputRow, COL_ATTENDANCE_TIME).NumberFormat = "h:mm"
                    .Cells(outputRow, COL_DEPARTURE_TIME).Value = departureTime
                    .Cells(outputRow, COL_DEPARTURE_TIME).NumberFormat = "h:mm"
                    
                    ' 赤でハイライト
                    .Range(.Cells(outputRow, 1), .Cells(outputRow, COL_DEPARTURE_TIME)).Interior.Color = COLOR_MISSING
                End With
                
                outputRow = outputRow + 1
                totalMissingCount = totalMissingCount + 1
                
                ' 漏れタイプ別カウント
                Select Case missingResult(1)
                    Case "出勤なし"
                        missingAttendanceCount = missingAttendanceCount + 1
                    Case "退勤なし"
                        missingDepartureCount = missingDepartureCount + 1
                    Case "出勤・退勤なし"
                        missingBothCount = missingBothCount + 1
                End Select
            End If
        End If
        
NextRow:
    Next i
    
    ' 結果が空の場合のメッセージ
    If outputRow = 2 Then
        With outputSheet
            .Cells(2, 1).Value = "勤怠入力漏れ・矛盾は検出されませんでした。"
            .Range(.Cells(2, 1), .Cells(2, COL_COMMENT)).Merge
            .Range(.Cells(2, 1), .Cells(2, COL_COMMENT)).HorizontalAlignment = xlCenter
        End With
    End If
    
    ' 統計情報の保存
    outputSheet.Range("J2").Value = totalMissingCount
    outputSheet.Range("J3").Value = missingAttendanceCount
    outputSheet.Range("J4").Value = missingDepartureCount
    outputSheet.Range("J5").Value = missingBothCount
    outputSheet.Range("J6").Value = employeeDict.Count
    outputSheet.Range("J7").Value = contradictionCount
    
    ' 統計データを非表示（白色の文字）
    outputSheet.Range("J2:J7").Font.Color = RGB(255, 255, 255)
    
    ' 列幅の自動調整
    outputSheet.Columns("A:I").AutoFit
    outputSheet.Columns("J").ColumnWidth = 0
    
    If DEBUG_MODE Then
        Debug.Print "=== 検出完了 ==="
        Debug.Print "総件数: " & totalMissingCount
        Debug.Print "矛盾: " & contradictionCount
        Debug.Print "出勤漏れ: " & missingAttendanceCount
        Debug.Print "退勤漏れ: " & missingDepartureCount
        Debug.Print "両方漏れ: " & missingBothCount
    End If
    
    Exit Sub
    
ErrorHandler:
    MsgBox "勤怠入力漏れの検出中にエラーが発生しました: " & Err.Description, vbCritical
    Resume Next
End Sub

' *************************************************************
' 関数名: CheckContradiction
' 目的: 申請内容と出退勤時刻の矛盾を検出
' 引数:
'   deliveryContent - 届出内容
'   attendanceTime - 出勤時刻
'   departureTime - 退勤時刻
' 戻り値: Array(矛盾フラグ, コメント)
' *************************************************************
Private Function CheckContradiction(deliveryContent As String, _
                                   attendanceTime As String, _
                                   departureTime As String) As Variant
    Dim hasContradiction As Boolean
    Dim comment As String
    
    hasContradiction = False
    comment = ""
    
    ' 午前有休の矛盾チェック
    If Trim(deliveryContent) = "午前有休" And attendanceTime <> "" Then
        Dim attendanceHour As Integer
        attendanceHour = GetHourFromTimeString(attendanceTime)
        
        If attendanceHour > 0 And attendanceHour < 13 Then
            Dim displayTime As String
            displayTime = FormatTimeDisplay(attendanceTime)
            hasContradiction = True
            comment = "午前有休なのに出勤時刻が13時より前（" & displayTime & "）になっています"
        End If
    End If
    
    ' 午後有休の矛盾チェック
    If Trim(deliveryContent) = "午後有休" And departureTime <> "" Then
        Dim departureHour As Integer
        Dim departureMinute As Integer
        departureHour = GetHourFromTimeString(departureTime)
        departureMinute = GetMinuteFromTimeString(departureTime)
        
        If departureHour > 12 Or (departureHour = 12 And departureMinute > 0) Then
            Dim displayDepartureTime As String
            displayDepartureTime = FormatTimeDisplay(departureTime)
            hasContradiction = True
            comment = "午後有休なのに退勤時刻が12時より後（" & displayDepartureTime & "）になっています"
        End If
    End If
    
    ' お昼休憩時間の矛盾チェック（矛盾が未検出の場合のみ）
    If Not hasContradiction Then
        ' 出勤時刻が12時台の場合
        If attendanceTime <> "" Then
            Dim attendanceHourLunch As Integer
            attendanceHourLunch = GetHourFromTimeString(attendanceTime)
            
            If attendanceHourLunch = 12 Then
                Dim displayLunchAttendTime As String
                displayLunchAttendTime = FormatTimeDisplay(attendanceTime)
                hasContradiction = True
                comment = "お昼休憩時間(12:00〜12:59)に出勤（" & displayLunchAttendTime & "）しています"
            End If
        End If
        
        ' 退勤時刻が12時台の場合（既に矛盾がない場合のみ）
        If Not hasContradiction And departureTime <> "" Then
            Dim departureHourLunch As Integer
            Dim departureMinuteLunch As Integer
            departureHourLunch = GetHourFromTimeString(departureTime)
            departureMinuteLunch = GetMinuteFromTimeString(departureTime)
            
            If departureHourLunch = 12 And departureMinuteLunch > 0 Then
                Dim displayLunchDepartTime As String
                displayLunchDepartTime = FormatTimeDisplay(departureTime)
                hasContradiction = True
                comment = "お昼休憩時間(12:01〜12:59)に退勤（" & displayLunchDepartTime & "）しています"
            End If
        End If
    End If
    
    CheckContradiction = Array(hasContradiction, comment)
End Function

' *************************************************************
' 関数名: CheckMissingEntry
' 目的: 出退勤時刻の漏れを検出
' 引数:
'   attendanceTime - 出勤時刻
'   departureTime - 退勤時刻
' 戻り値: Array(漏れフラグ, 漏れタイプ, コメント)
' *************************************************************
Private Function CheckMissingEntry(attendanceTime As String, _
                                  departureTime As String) As Variant
    Dim hasMissing As Boolean
    Dim missingType As String
    Dim comment As String
    
    hasMissing = False
    missingType = ""
    comment = ""
    
    Dim hasAttendance As Boolean
    Dim hasDeparture As Boolean
    
    hasAttendance = (Trim(attendanceTime) <> "" And Not IsEmpty(attendanceTime))
    hasDeparture = (Trim(departureTime) <> "" And Not IsEmpty(departureTime))
    
    If Not hasAttendance And Not hasDeparture Then
        hasMissing = True
        missingType = "出勤・退勤なし"
        comment = "出勤時刻と退勤時刻の両方が入力されていません"
    ElseIf Not hasAttendance Then
        hasMissing = True
        missingType = "出勤なし"
        comment = "出勤時刻が入力されていません"
    ElseIf Not hasDeparture Then
        hasMissing = True
        missingType = "退勤なし"
        comment = "退勤時刻が入力されていません"
    End If
    
    CheckMissingEntry = Array(hasMissing, missingType, comment)
End Function

' *************************************************************
' 関数名: GetColumnIndexes
' 目的: 列インデックスを辞書形式で取得
' 戻り値: Dictionary(列名 -> 列番号)
' *************************************************************
Private Function GetColumnIndexes(ws As Worksheet) As Object
    Dim dict As Object
    Set dict = CreateObject("Scripting.Dictionary")
    
    Dim lastCol As Long
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column
    
    Dim i As Long
    For i = 1 To lastCol
        Dim headerName As String
        headerName = Trim(CStr(ws.Cells(1, i).Value))
        
        If headerName <> "" Then
            dict(headerName) = i
        End If
    Next i
    
    ' 必須列のチェック（実際の列名に修正）
    Dim requiredColumns As Variant
    requiredColumns = Array("社員番号", "氏名", "日付", "カレンダー", "届出内容", "出社", "退社")
    
    Dim col As Variant
    For Each col In requiredColumns
        If Not dict.Exists(col) Then
            MsgBox "必要な列「" & col & "」が見つかりません。", vbExclamation
            Set GetColumnIndexes = Nothing
            Exit Function
        End If
    Next col
    
    Set GetColumnIndexes = dict
End Function

' *************************************************************
' 関数名: IsEntryRequired
' 目的: 勤怠入力が必要かどうかを判断
' *************************************************************
Public Function IsEntryRequired(calendarType As String, deliveryContent As String) As Boolean
    IsEntryRequired = True
    
    If InStr(1, calendarType, "法定外", vbTextCompare) > 0 Then
        IsEntryRequired = False
        
        If InStr(1, deliveryContent, "休日出勤", vbTextCompare) > 0 Or _
           InStr(1, deliveryContent, "休出", vbTextCompare) > 0 Then
            IsEntryRequired = True
        End If
    ElseIf InStr(1, calendarType, "平日", vbTextCompare) > 0 Then
        If Trim(deliveryContent) = "" Then
            IsEntryRequired = True
        Else
            Select Case Trim(deliveryContent)
                Case "有休", "欠勤", "振替休暇", "特別休暇"
                    IsEntryRequired = False
                Case "時間有休", "午前有休", "午後有休"
                    IsEntryRequired = True
                Case Else
                    IsEntryRequired = True
            End Select
        End If
    End If
End Function

' *************************************************************
' 時刻解析・フォーマット用ヘルパー関数
' *************************************************************
Private Function GetHourFromTimeString(timeStr As String) As Integer
    On Error Resume Next
    
    If IsNumeric(timeStr) Then
        GetHourFromTimeString = hour(CDbl(timeStr))
    Else
        Dim timeParts As Variant
        timeParts = Split(timeStr, ":")
        If UBound(timeParts) >= 0 Then
            GetHourFromTimeString = CInt(timeParts(0))
        Else
            GetHourFromTimeString = 0
        End If
    End If
    
    On Error GoTo 0
End Function

Private Function GetMinuteFromTimeString(timeStr As String) As Integer
    On Error Resume Next
    
    If IsNumeric(timeStr) Then
        GetMinuteFromTimeString = minute(CDbl(timeStr))
    Else
        Dim timeParts As Variant
        timeParts = Split(timeStr, ":")
        If UBound(timeParts) >= 1 Then
            GetMinuteFromTimeString = CInt(timeParts(1))
        Else
            GetMinuteFromTimeString = 0
        End If
    End If
    
    On Error GoTo 0
End Function

Private Function FormatTimeDisplay(timeStr As String) As String
    On Error Resume Next
    
    If IsNumeric(timeStr) Then
        FormatTimeDisplay = Format(CDbl(timeStr), "h:mm")
    Else
        FormatTimeDisplay = timeStr
    End If
    
    On Error GoTo 0
End Function

