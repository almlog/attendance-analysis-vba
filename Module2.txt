' ========================================
' Module5 (完全修正版 - 2025-11-17 最終版)
' タイプ: 標準モジュール
' 修正内容: J列に矛盾種別コードを確実に書き込む
' ========================================

Option Explicit

' *************************************************************
' モジュール：勤怠入力漏れ検出
' 目的：勤怠入力漏れと申請矛盾を検出する
' *************************************************************

' 定数定義
Private Const COL_EMPLOYEE_ID As Integer = 1
Private Const COL_EMPLOYEE_NAME As Integer = 2
Private Const COL_DATE As Integer = 3
Private Const COL_DAY_TYPE As Integer = 4
Private Const COL_LEAVE_TYPE As Integer = 5
Private Const COL_MISSING_ENTRY_TYPE As Integer = 6
Private Const COL_COMMENT As Integer = 7
Private Const COL_ATTENDANCE_TIME As Integer = 8
Private Const COL_DEPARTURE_TIME As Integer = 9
Private Const COL_CONTRADICTION_TYPE As Integer = 10 ' J列
Private Const DEBUG_MODE As Boolean = True ' デバッグモード有効化

' ハイライト色定義
Private Const COLOR_CONTRADICTION As Long = 16750848  ' オレンジ
Private Const COLOR_MISSING As Long = 16764108        ' 赤

' *************************************************************
' 関数名: DetectMissingEntries
' 目的: 勤怠入力漏れと申請矛盾を検出
' *************************************************************
Public Sub DetectMissingEntries(wsCSVData As Worksheet, outputSheet As Worksheet)
    Dim includeToday As Boolean
    includeToday = g_IncludeToday
    
    On Error GoTo ErrorHandler
    Application.StatusBar = "勤怠入力漏れ・矛盾を検出しています..."
    
    ' 最終行を取得
    Dim lastRow As Long
    lastRow = wsCSVData.Cells(wsCSVData.Rows.count, "A").End(xlUp).Row
    
    If lastRow <= 1 Then
        MsgBox "CSVデータが存在しません。", vbExclamation
        Exit Sub
    End If
    
    ' 列インデックスの特定
    Dim colIndex As Object
    Set colIndex = GetColumnIndexes(wsCSVData)
    If colIndex Is Nothing Then Exit Sub
    
    ' データを配列に読み込み
    Dim dataArray As Variant
    dataArray = wsCSVData.Range(wsCSVData.Cells(2, 1), _
                                wsCSVData.Cells(lastRow, wsCSVData.Cells(1, wsCSVData.Columns.count).End(xlToLeft).Column)).Value
    
    ' 変数定義
    Dim employeeDict As Object
    Set employeeDict = CreateObject("Scripting.Dictionary")
    Dim totalMissingCount As Long, missingAttendanceCount As Long, missingDepartureCount As Long, missingBothCount As Long, contradictionCount As Long
    totalMissingCount = 0: missingAttendanceCount = 0: missingDepartureCount = 0: missingBothCount = 0: contradictionCount = 0
    Dim outputRow As Long
    outputRow = 2
    
    Dim i As Long
    For i = 1 To UBound(dataArray, 1)
        ' --- データ取得とクリーニング ---
        Dim employeeID As String, employeeName As String
        Dim entryDate As Date
        Dim dayType As String, deliveryContent As String
        Dim attendanceTime As String, departureTime As String
        
        ' CleanString関数を通してゴミを除去
        employeeID = CleanString(dataArray(i, colIndex("社員番号")))
        employeeName = CleanString(dataArray(i, colIndex("氏名")))
        dayType = CleanString(dataArray(i, colIndex("カレンダー")))
        deliveryContent = CleanString(dataArray(i, colIndex("届出内容")))
        attendanceTime = CleanString(dataArray(i, colIndex("出社")))
        departureTime = CleanString(dataArray(i, colIndex("退社")))
        
        ' 日付変換（エラー時はスキップ）
        On Error Resume Next
        entryDate = CDate(dataArray(i, colIndex("日付")))
        If Err.Number <> 0 Then
            On Error GoTo ErrorHandler
            GoTo NextRow
        End If
        On Error GoTo ErrorHandler
        
        ' 勤怠入力が必要かどうかを判定
        If Not IsEntryRequired(dayType, deliveryContent) Then GoTo NextRow
        
        ' === 第1段階：矛盾検出 ===
        Dim contradictionResult As Variant
        contradictionResult = CheckContradiction(deliveryContent, attendanceTime, departureTime)
        
        ' ★★★ デバッグログ追加 ★★★
        If DEBUG_MODE Then
            Debug.Print "[DEBUG] 行" & (i + 1) & ": " & employeeName & " - 矛盾チェック結果=" & contradictionResult(0) & ", コード=" & contradictionResult(2)
        End If
        
        If contradictionResult(0) Then
            ' 矛盾あり
            If Not employeeDict.Exists(employeeID) Then employeeDict.Add employeeID, employeeName
            
            With outputSheet
                .Cells(outputRow, COL_EMPLOYEE_ID).Value = employeeID
                .Cells(outputRow, COL_EMPLOYEE_NAME).Value = employeeName
                .Cells(outputRow, COL_DATE).Value = entryDate
                .Cells(outputRow, COL_DAY_TYPE).Value = dayType
                .Cells(outputRow, COL_LEAVE_TYPE).Value = deliveryContent
                .Cells(outputRow, COL_MISSING_ENTRY_TYPE).Value = ""
                .Cells(outputRow, COL_COMMENT).Value = contradictionResult(1)
                .Cells(outputRow, COL_ATTENDANCE_TIME).Value = attendanceTime
                .Cells(outputRow, COL_DEPARTURE_TIME).Value = departureTime
                
                ' ★★★ 重要：矛盾種別コードをJ列に書き込む ★★★
                .Cells(outputRow, COL_CONTRADICTION_TYPE).Value = contradictionResult(2)
                
                Debug.Print "[INFO] ★矛盾をシートに書き込み: 行" & outputRow & ", J列=" & contradictionResult(2)
                
                .Range(.Cells(outputRow, 1), .Cells(outputRow, COL_DEPARTURE_TIME)).Interior.Color = COLOR_CONTRADICTION
            End With
            
            outputRow = outputRow + 1
            contradictionCount = contradictionCount + 1
            totalMissingCount = totalMissingCount + 1
        Else
            ' === 第2段階：勤怠漏れ検出 ===
            Dim missingResult As Variant
            missingResult = CheckMissingEntry(attendanceTime, departureTime)
            
            If missingResult(0) Then
                ' 漏れあり
                If Not employeeDict.Exists(employeeID) Then employeeDict.Add employeeID, employeeName
                
                With outputSheet
                    .Cells(outputRow, COL_EMPLOYEE_ID).Value = employeeID
                    .Cells(outputRow, COL_EMPLOYEE_NAME).Value = employeeName
                    .Cells(outputRow, COL_DATE).Value = entryDate
                    .Cells(outputRow, COL_DAY_TYPE).Value = dayType
                    .Cells(outputRow, COL_LEAVE_TYPE).Value = deliveryContent
                    .Cells(outputRow, COL_MISSING_ENTRY_TYPE).Value = missingResult(1)
                    .Cells(outputRow, COL_COMMENT).Value = missingResult(2)
                    .Cells(outputRow, COL_ATTENDANCE_TIME).Value = attendanceTime
                    .Cells(outputRow, COL_DEPARTURE_TIME).Value = departureTime
                    
                    ' 矛盾なしの場合は0をセット
                    .Cells(outputRow, COL_CONTRADICTION_TYPE).Value = 0
                    
                    .Range(.Cells(outputRow, 1), .Cells(outputRow, COL_DEPARTURE_TIME)).Interior.Color = COLOR_MISSING
                End With
                
                outputRow = outputRow + 1
                totalMissingCount = totalMissingCount + 1
                
                Select Case missingResult(1)
                    Case "出勤なし": missingAttendanceCount = missingAttendanceCount + 1
                    Case "退勤なし": missingDepartureCount = missingDepartureCount + 1
                    Case "出勤・退勤なし": missingBothCount = missingBothCount + 1
                End Select
            End If
        End If
NextRow:
    Next i
    
    ' 結果書き込みと後処理
    If outputRow = 2 Then
        outputSheet.Cells(2, 1).Value = "勤怠入力漏れ・矛盾は検出されませんでした。"
        outputSheet.Range(outputSheet.Cells(2, 1), outputSheet.Cells(2, COL_COMMENT)).Merge
        outputSheet.Range(outputSheet.Cells(2, 1), outputSheet.Cells(2, COL_COMMENT)).HorizontalAlignment = xlCenter
    End If
    
    ' 統計情報
    With outputSheet
        .Range("J2").Value = totalMissingCount
        .Range("J3").Value = missingAttendanceCount
        .Range("J4").Value = missingDepartureCount
        .Range("J5").Value = missingBothCount
        .Range("J6").Value = employeeDict.count
        .Range("J7").Value = contradictionCount
        .Range("J2:J7").Font.Color = RGB(255, 255, 255) ' 白文字で見えなくする
        .Columns("A:I").AutoFit
        .Columns("J").ColumnWidth = 0 ' J列を隠す
    End With
    
    If DEBUG_MODE Then Debug.Print "[INFO] 検出完了: 総件数=" & totalMissingCount & "件, 矛盾=" & contradictionCount & "件"
    Exit Sub
    
ErrorHandler:
    MsgBox "勤怠入力漏れの検出中にエラーが発生しました: " & Err.Description, vbCritical
    Resume Next
End Sub

' *************************************************************
' 関数名: CleanString
' 目的: セル値からゴミ文字、NBSP、エラー値を安全に除去して文字列化
' *************************************************************
Private Function CleanString(val As Variant) As String
    If IsError(val) Then
        CleanString = ""
        Exit Function
    End If
    
    If IsNull(val) Or IsEmpty(val) Then
        CleanString = ""
        Exit Function
    End If
    
    Dim s As String
    s = CStr(val)
    
    ' 1. ノーブレークスペース(160)を通常スペース(32)に置換
    If InStr(s, ChrW(160)) > 0 Then
        s = Replace(s, ChrW(160), " ")
    End If
    
    ' 2. タブ、改行を除去
    s = Replace(s, vbTab, "")
    s = Replace(s, vbCr, "")
    s = Replace(s, vbLf, "")
    
    ' 3. 制御文字(0-31)の除去
    Dim i As Long
    Dim clean As String
    clean = ""
    For i = 1 To Len(s)
        Dim c As String
        c = Mid(s, i, 1)
        If AscW(c) >= 32 Then
            clean = clean & c
        End If
    Next i
    
    ' 4. 前後の空白削除
    CleanString = Trim(clean)
End Function

' *************************************************************
' 関数名: CheckContradiction
' 目的: 申請内容と出退勤時刻の矛盾を検出
' 戻り値: Array(矛盾フラグ, コメント, 矛盾種別コード)
' *************************************************************
Private Function CheckContradiction(deliveryContent As String, attendanceTime As String, departureTime As String) As Variant
    Dim hasContradiction As Boolean: hasContradiction = False
    Dim comment As String: comment = ""
    Dim contradictionType As Integer: contradictionType = 0
    
    ' 午前有休の矛盾チェック
    If deliveryContent = "午前有休" And attendanceTime <> "" Then
        Dim attHour As Integer
        attHour = GetHourFromTimeString(attendanceTime)
        If attHour > 0 And attHour < 13 Then
            hasContradiction = True
            comment = "午前有休なのに出勤時刻が13時より前（" & FormatTimeDisplay(attendanceTime) & "）になっています"
            contradictionType = 1  ' ★ 午前有休矛盾
        End If
    End If
    
    ' 午後有休の矛盾チェック
    If deliveryContent = "午後有休" And departureTime <> "" Then
        Dim depH As Integer, depM As Integer
        depH = GetHourFromTimeString(departureTime)
        depM = GetMinuteFromTimeString(departureTime)
        If depH > 12 Or (depH = 12 And depM > 0) Then
            hasContradiction = True
            comment = "午後有休なのに退勤時刻が12時より後（" & FormatTimeDisplay(departureTime) & "）になっています"
            contradictionType = 2  ' ★ 午後有休矛盾
        End If
    End If
    
    ' お昼休憩時間の矛盾チェック（矛盾が未検出の場合のみ）
    If Not hasContradiction And attendanceTime <> "" Then
        If GetHourFromTimeString(attendanceTime) = 12 Then
            hasContradiction = True
            comment = "お昼休憩時間(12:00～12:59)に出勤（" & FormatTimeDisplay(attendanceTime) & "）しています"
            contradictionType = 3  ' ★ お昼休憩時間矛盾
        End If
    End If
    
    If Not hasContradiction And departureTime <> "" Then
        Dim dH As Integer, dM As Integer
        dH = GetHourFromTimeString(departureTime)
        dM = GetMinuteFromTimeString(departureTime)
        If dH = 12 And dM > 0 Then
            hasContradiction = True
            comment = "お昼休憩時間(12:01～12:59)に退勤（" & FormatTimeDisplay(departureTime) & "）しています"
            contradictionType = 3  ' ★ お昼休憩時間矛盾
        End If
    End If
    
    ' ★★★ 重要：3要素のArrayを返す ★★★
    CheckContradiction = Array(hasContradiction, comment, contradictionType)
End Function

' *************************************************************
' 関数名: CheckMissingEntry
' 目的: 出退勤時刻の漏れを検出
' *************************************************************
Private Function CheckMissingEntry(attendanceTime As String, departureTime As String) As Variant
    Dim hasAttendance As Boolean, hasDeparture As Boolean
    hasAttendance = (attendanceTime <> "")
    hasDeparture = (departureTime <> "")
    
    If Not hasAttendance And Not hasDeparture Then
        CheckMissingEntry = Array(True, "出勤・退勤なし", "出勤時刻と退勤時刻の両方が入力されていません")
    ElseIf Not hasAttendance Then
        CheckMissingEntry = Array(True, "出勤なし", "出勤時刻が入力されていません")
    ElseIf Not hasDeparture Then
        CheckMissingEntry = Array(True, "退勤なし", "退勤時刻が入力されていません")
    Else
        CheckMissingEntry = Array(False, "", "")
    End If
End Function

' *************************************************************
' 関数名: GetColumnIndexes
' *************************************************************
Private Function GetColumnIndexes(ws As Worksheet) As Object
    Dim dict As Object: Set dict = CreateObject("Scripting.Dictionary")
    Dim lastCol As Long: lastCol = ws.Cells(1, ws.Columns.count).End(xlToLeft).Column
    Dim i As Long
    For i = 1 To lastCol
        dict(CleanString(ws.Cells(1, i).Value)) = i
    Next i
    
    Dim required As Variant: required = Array("社員番号", "氏名", "日付", "カレンダー", "届出内容", "出社", "退社")
    Dim c As Variant
    For Each c In required
        If Not dict.Exists(c) Then
            MsgBox "必要な列「" & c & "」が見つかりません。", vbExclamation
            Set GetColumnIndexes = Nothing: Exit Function
        End If
    Next c
    Set GetColumnIndexes = dict
End Function

' *************************************************************
' 関数名: IsEntryRequired
' *************************************************************
Public Function IsEntryRequired(calendarType As String, deliveryContent As String) As Boolean
    IsEntryRequired = True
    If InStr(1, calendarType, "法定外", vbTextCompare) > 0 Then
        IsEntryRequired = False
        If InStr(1, deliveryContent, "休出") > 0 Or InStr(1, deliveryContent, "休日出勤") > 0 Then IsEntryRequired = True
    ElseIf InStr(1, calendarType, "平日", vbTextCompare) > 0 Then
        Select Case deliveryContent
            Case "有休", "欠勤", "振替休暇", "特別休暇": IsEntryRequired = False
            Case Else: IsEntryRequired = True
        End Select
    End If
End Function

' *************************************************************
' 時刻解析・フォーマット用ヘルパー関数
' *************************************************************
Private Function GetHourFromTimeString(timeStr As String) As Integer
    On Error Resume Next
    If IsNumeric(timeStr) Then
        GetHourFromTimeString = hour(CDbl(timeStr))
    Else
        Dim parts: parts = Split(timeStr, ":")
        If UBound(parts) >= 0 Then GetHourFromTimeString = CInt(parts(0)) Else GetHourFromTimeString = 0
    End If
End Function

Private Function GetMinuteFromTimeString(timeStr As String) As Integer
    On Error Resume Next
    If IsNumeric(timeStr) Then
        GetMinuteFromTimeString = minute(CDbl(timeStr))
    Else
        Dim parts: parts = Split(timeStr, ":")
        If UBound(parts) >= 1 Then GetMinuteFromTimeString = CInt(parts(1)) Else GetMinuteFromTimeString = 0
    End If
End Function

Private Function FormatTimeDisplay(timeStr As String) As String
    On Error Resume Next
    If IsNumeric(timeStr) Then
        FormatTimeDisplay = Format(CDbl(timeStr), "h:mm")
    Else
        FormatTimeDisplay = timeStr
    End If
    On Error GoTo 0
End Function

