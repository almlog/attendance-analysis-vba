# ユーザーストーリー

## エピック構造

```
勤怠未入力通知システム
├─ Epic 1: CSV管理
│   ├─ Story 1.1: CSV読込
│   └─ Story 1.2: データ検証
├─ Epic 2: 通知管理
│   ├─ Story 2.1: 管理者チャンネル通知
│   ├─ Story 2.2: 個別トーク通知
│   └─ Story 2.3: 通知履歴管理
├─ Epic 3: 社員マスタ管理
│   ├─ Story 3.1: マスタ登録
│   └─ Story 3.2: マスタ検索・更新
└─ Epic 4: 運用・保守
    ├─ Story 4.1: エラー対応
    └─ Story 4.2: パフォーマンス監視
```

---

## Epic 1: CSV管理

### Story 1.1: CSV読込機能

**ユーザーストーリー**:
```
人事担当者として、
勤怠システムから出力したCSVファイルを簡単に読み込みたい
なぜなら、毎日の未入力者確認作業を効率化したいから
```

**受入基準**:
- [ ] ボタンをクリックするとファイル選択ダイアログが開く
- [ ] 選択したCSVファイルの内容が「勤怠未入力」シートに表示される
- [ ] 読み込み完了時に件数が表示される
- [ ] 既存データがある場合は上書き確認ダイアログが表示される

**タスク**:
1. [ ] ファイル選択ダイアログの実装
2. [ ] CSV解析ロジックの実装
3. [ ] シートへのデータ書き込み
4. [ ] 未入力日数の自動計算
5. [ ] 社員マスタとの照合（メール有無チェック）

**優先度**: 🔥 最高
**見積もり**: 3 Story Points
**実装フェーズ**: Phase 1

**シナリオ例**:
```gherkin
Scenario: 正常なCSVファイルを読み込む
  Given 勤怠管理.xlsmを開いている
  And CSVファイル "勤怠未入力_20251017.csv" が存在する
  When "📥 CSV読込" ボタンをクリックする
  And ファイル選択ダイアログでCSVファイルを選択する
  Then シートに30件のデータが表示される
  And "30件のデータを読み込みました" というメッセージが表示される
  And 未入力日数が自動計算されている
```

---

### Story 1.2: データ検証機能

**ユーザーストーリー**:
```
人事担当者として、
読み込んだCSVデータに問題がないか自動チェックしてほしい
なぜなら、不正なデータで通知を送信するとトラブルになるから
```

**受入基準**:
- [ ] 必須列（社員番号、氏名、日付、コメント）の欠損を検出できる
- [ ] 日付形式エラーを検出できる
- [ ] 重複データ（同一社員・同一日付）を検出できる
- [ ] エラー検出時は具体的なエラー内容が表示される
- [ ] 警告レベルのエラーは読み込みを継続できる

**タスク**:
1. [ ] 必須列チェック機能
2. [ ] 日付形式検証
3. [ ] 重複データ検出
4. [ ] エラーメッセージ生成
5. [ ] エラーログ記録

**優先度**: ⚠️ 高
**見積もり**: 2 Story Points
**実装フェーズ**: Phase 2

**シナリオ例**:
```gherkin
Scenario: 日付形式エラーのあるCSVを読み込む
  Given 日付列に "2025/13/40" という不正な日付が含まれるCSVファイル
  When "📥 CSV読込" ボタンをクリックする
  Then "3行目: 日付形式が正しくありません (2025/13/40)" というエラーが表示される
  And エラー行を除いた残りのデータは読み込まれる
```

---

## Epic 2: 通知管理

### Story 2.1: 管理者チャンネル通知

**ユーザーストーリー**:
```
部門管理者として、
LINE WORKSの管理者チャンネルで未入力者リストを確認したい
なぜなら、どの社員にいつ声をかけるべきか優先順位をつけたいから
```

**受入基準**:
- [ ] ボタンをクリックすると送信確認ダイアログが表示される
- [ ] 管理者チャンネルに未入力者リストが送信される
- [ ] 緊急度別（🔴5日以上/🟡3-4日/🟢1-2日）に色分けされている
- [ ] 各社員の未入力日リストが見やすく表示される
- [ ] 送信成功時に完了メッセージが表示される

**タスク**:
1. [ ] 未入力者データの集約ロジック
2. [ ] 緊急度判定ロジック
3. [ ] メッセージフォーマット生成
4. [ ] Webhook API呼び出し
5. [ ] エラーハンドリング
6. [ ] 送信履歴の記録

**優先度**: 🔥 最高
**見積もり**: 5 Story Points
**実装フェーズ**: Phase 1

**シナリオ例**:
```gherkin
Scenario: 管理者チャンネルに通知を送信する
  Given 3名の未入力者がいる（田中:3日前、佐藤:3日前、鈴木:5日前）
  When "📤 管理者通知" ボタンをクリックする
  And 確認ダイアログで "はい" をクリックする
  Then LINE WORKS管理者チャンネルにメッセージが送信される
  And メッセージには以下が含まれる
    """
    【勤怠未入力アラート】2025年10月17日
    
    未入力者: 3名 / 未入力件数: 5件
    
    ■ 緊急対応（5日以上）
    🔴 鈴木一郎 さん
      ・10/14（4日前）
      ・10/15（3日前）
    
    ■ 要注意（3-4日）
    🟡 田中太郎 さん
      ・10/15（3日前）
    🟡 佐藤花子 さん
      ・10/15（3日前）
    """
  And 通知履歴シートに記録される
```

**受入基準の詳細化**:
- メッセージ形式:
  - ヘッダー: 日付、サマリー（対象者数/未入力件数）
  - 本文: 緊急度別セクション
  - 詳細: 各社員の氏名 + 未入力日リスト
  - フッター: 対応依頼文
- 視認性:
  - 絵文字による緊急度の視覚化
  - 改行・インデントによる階層構造
  - 日付は「m/d（aaa）」形式
- エラー処理:
  - HTTP 4xx/5xx エラー時の明確なメッセージ
  - リトライ可能なエラーの識別

---

### Story 2.2: 個別トーク通知（将来実装）

**ユーザーストーリー**:
```
一般社員として、
勤怠未入力時にLINE WORKSで個人的にリマインドを受け取りたい
なぜなら、他の人に未入力を知られずに対応したいから
```

**受入基準**:
- [ ] 社員マスタにLINEWORKSメールが登録されている社員のみ送信される
- [ ] 本人宛ての1対1トークとして送信される
- [ ] メッセージは丁寧で建設的な文面である
- [ ] 未入力日のリストが含まれる
- [ ] 勤怠システムへのリンクが含まれる
- [ ] 送信エラー時は管理者に通知される

**タスク**:
1. [ ] Bot API認証実装
2. [ ] ユーザーID取得ロジック
3. [ ] 個別メッセージ送信
4. [ ] エラーハンドリング
5. [ ] 送信状況の可視化

**優先度**: 📅 中
**見積もり**: 8 Story Points
**実装フェーズ**: Phase 3

**シナリオ例**:
```gherkin
Scenario: 個別トークで通知を送信する
  Given 田中太郎さんの社員マスタにLINEWORKSメール "tanaka@company.com" が登録されている
  And 田中太郎さんに10/15の未入力がある
  When "📧 個別通知" ボタンをクリックする
  Then 田中太郎さんのLINE WORKSトークにメッセージが送信される
  And メッセージには以下が含まれる
    """
    お疲れさまです🌟
    
    以下の日付の勤怠入力をお願いします：
    ・10月15日（水）
    
    勤怠システム: https://example.com/attendance
    
    ※このメッセージは自動送信です
    """
```

---

### Story 2.3: 通知履歴管理

**ユーザーストーリー**:
```
人事担当者として、
過去の通知履歴を確認したい
なぜなら、どの社員に何回通知したか把握し、個別対応が必要か判断したいから
```

**受入基準**:
- [ ] 通知送信時に自動で履歴が記録される
- [ ] 履歴には送信日時、通知方法、対象者数、結果が記録される
- [ ] 「📊 履歴」ボタンで履歴シートが表示される
- [ ] 履歴は日付降順で表示される
- [ ] CSVエクスポート機能がある（将来実装）

**タスク**:
1. [ ] 履歴記録ロジック
2. [ ] 履歴シート設計
3. [ ] 履歴表示機能
4. [ ] 検索・フィルタ機能（将来実装）
5. [ ] CSVエクスポート（将来実装）

**優先度**: ⚠️ 高
**見積もり**: 2 Story Points
**実装フェーズ**: Phase 1

**シナリオ例**:
```gherkin
Scenario: 通知履歴を確認する
  Given 過去に3回通知を送信している
  When "📊 履歴" ボタンをクリックする
  Then 通知履歴シートが表示される
  And 以下の情報が記録されている
    | 送信日時 | 通知方法 | 対象者数 | 対象日付 | 結果 |
    | 2025/10/17 09:00 | 管理者Ch | 3 | 2025/10/15 | 成功 |
    | 2025/10/16 09:00 | 管理者Ch | 5 | 2025/10/14 | 成功 |
    | 2025/10/15 09:00 | 管理者Ch | 2 | 2025/10/13 | 成功 |
```

---

## Epic 3: 社員マスタ管理

### Story 3.1: 社員マスタ自動登録

**ユーザーストーリー**:
```
人事担当者として、
CSVを読み込んだ時に新しい社員が自動的に社員マスタに追加されてほしい
なぜなら、手動で社員を追加する手間を省きたいから
```

**受入基準**:
- [ ] CSV読込時に未登録の社員番号を検出する
- [ ] 未登録社員を社員マスタに自動追加する
- [ ] 追加時に社員番号と氏名のみ登録され、LINEWORKSメールは空欄
- [ ] 追加された社員数が通知される
- [ ] 追加日が自動記録される

**タスク**:
1. [ ] 社員マスタ存在チェック
2. [ ] 新規社員の抽出
3. [ ] 自動登録処理
4. [ ] 登録通知

**優先度**: ⚠️ 高
**見積もり**: 3 Story Points
**実装フェーズ**: Phase 2

**シナリオ例**:
```gherkin
Scenario: 新規社員が自動登録される
  Given 社員マスタに登録されていない社員番号 "2010001" がCSVに含まれる
  When CSVを読み込む
  Then 社員マスタに以下が追加される
    | 社員番号 | 氏名 | LINEWORKSメール | 更新日 |
    | 2010001 | 新入太郎 | (空欄) | 2025/10/17 |
  And "社員マスタに1名を追加しました" というメッセージが表示される
```

---

### Story 3.2: 社員マスタ手動更新

**ユーザーストーリー**:
```
人事担当者として、
社員のLINE WORKSメールアドレスを手動で入力したい
なぜなら、個別通知機能を利用するために紐付け情報が必要だから
```

**受入基準**:
- [ ] 社員マスタシートで直接編集できる
- [ ] 入力済み人数がリアルタイムで更新される
- [ ] メールアドレス形式の妥当性を検証する（将来実装）
- [ ] 更新日が自動記録される
- [ ] 編集履歴が記録される（将来実装）

**タスク**:
1. [ ] 社員マスタシートの設計
2. [ ] 入力済みカウント機能
3. [ ] 書式設定（条件付き書式）
4. [ ] バリデーション機能（将来実装）

**優先度**: 📅 中
**見積もり**: 2 Story Points
**実装フェーズ**: Phase 2

**シナリオ例**:
```gherkin
Scenario: LINEWORKSメールアドレスを入力する
  Given 社員マスタに田中太郎さん（社員番号: 1904010）が登録されている
  When C列に "tanaka@company.com" を入力する
  Then D列（更新日）が自動的に今日の日付になる
  And G1セル（入力済み人数）が "1" に更新される
  And 勤怠未入力シートのG列（メール有無）が "✓" に変わる
```

---

## Epic 4: 運用・保守

### Story 4.1: エラー対応ガイド

**ユーザーストーリー**:
```
人事担当者として、
エラーが発生した時に具体的な対処方法を知りたい
なぜなら、IT部門に依頼せずに自己解決したいから
```

**受入基準**:
- [ ] すべてのエラーメッセージに対処方法が記載されている
- [ ] エラーの重要度が分かる（エラー/警告/情報）
- [ ] トラブルシューティングガイドが整備されている
- [ ] よくある問題のFAQがある
- [ ] エラーログが自動記録される

**タスク**:
1. [ ] エラーメッセージの標準化
2. [ ] トラブルシューティングガイド作成
3. [ ] FAQ作成
4. [ ] エラーログ機能実装

**優先度**: ⚠️ 高
**見積もり**: 3 Story Points
**実装フェーズ**: Phase 2

**シナリオ例**:
```gherkin
Scenario: Webhook送信エラーが発生する
  Given Webhook URLが間違っている
  When "📤 管理者通知" ボタンをクリックする
  Then 以下のエラーメッセージが表示される
    """
    ❌ 送信エラー: HTTP 404 Not Found
    
    【原因】
    Webhook URLが正しくない可能性があります。
    
    【対処方法】
    1. [設定]シートを開く
    2. B1セルのWebhook URLを確認
    3. LINE WORKS管理画面で正しいURLを再取得
    4. 再度送信を試す
    
    それでも解決しない場合はIT部門に連絡してください。
    """
```

---

### Story 4.2: パフォーマンス監視

**ユーザーストーリー**:
```
システム管理者として、
処理時間やメモリ使用量を監視したい
なぜなら、パフォーマンス問題を早期に検出し、対処したいから
```

**受入基準**:
- [ ] CSV読込時間が記録される
- [ ] 通知送信時間が記録される
- [ ] 処理時間が基準値を超えた場合に警告される
- [ ] パフォーマンスレポートが生成される（将来実装）

**タスク**:
1. [ ] 処理時間計測機能
2. [ ] パフォーマンスログ記録
3. [ ] 閾値監視
4. [ ] レポート生成（将来実装）

**優先度**: 📋 低
**見積もり**: 2 Story Points
**実装フェーズ**: Phase 4

---

## ペルソナ定義

### ペルソナ1: 人事担当者（山田花子さん）

**プロフィール**:
- 年齢: 35歳
- 役職: 人事課 主任
- 勤務年数: 10年
- ITスキル: 中級（Excel VLOOKUPは使える）
- 業務内容: 勤怠管理、給与計算サポート

**ゴール**:
- 毎日の未入力者確認作業を5分以内に完了したい
- 月末締め処理を予定通りに完了させたい
- ミスなく正確に勤怠データを管理したい

**ペインポイント**:
- 毎日15分かけて手動で未入力者を確認している
- 未入力者への連絡を忘れることがある
- 月末に未入力が大量に発生して残業になる

**利用シーン**:
- 毎朝9:00にCSVをダウンロードして確認
- 未入力者がいたら管理者チャンネルに投稿
- 週1回、社員マスタを更新

---

### ペルソナ2: 部門管理者（佐藤一郎さん）

**プロフィール**:
- 年齢: 45歳
- 役職: 営業部 課長
- 勤務年数: 20年
- ITスキル: 初級（スマホでLINE WORKSは使える）
- 業務内容: 部下の勤怠管理、営業マネジメント

**ゴール**:
- 部下の勤怠状況を簡単に把握したい
- 未入力者に効果的に督促したい
- 人事部とのやり取りを減らしたい

**ペインポイント**:
- 誰が未入力か分からず、全員に声をかけてしまう
- 督促のタイミングが遅れて、記憶が曖昧になる
- LINE WORKSで通知が来ても、優先順位が分からない

**利用シーン**:
- 管理者チャンネルで通知を受け取る
- 緊急度の高い社員から順に声をかける
- 週末に未対応者をフォロー

---

### ペルソナ3: 一般社員（鈴木太郎さん）

**プロフィール**:
- 年齢: 28歳
- 役職: 営業部 一般社員
- 勤務年数: 3年
- ITスキル: 中級（スマホ・PCともに普通に使える）
- 業務内容: 外回り営業

**ゴール**:
- 勤怠入力を忘れたくない
- 忘れた時はすぐに気づきたい
- 他の人に未入力を知られたくない

**ペインポイント**:
- 外回りが多く、夜に勤怠入力を忘れる
- 管理者に注意されるのが恥ずかしい
- 何日分も溜まると、記憶が曖昧で困る

**利用シーン**（将来実装）:
- LINE WORKSで個別にリマインド通知を受け取る
- 通知を見てすぐに勤怠システムで入力
- 通知がプライベートなので心理的負担が少ない

---

## ユーザージャーニーマップ

### 山田花子さん（人事担当者）の1日

| 時刻 | アクション | 思考・感情 | タッチポイント | 改善機会 |
|------|-----------|-----------|---------------|----------|
| 8:50 | 出社、PCログイン | 今日も未入力者チェックか... | PC、勤怠システム | - |
| 9:00 | 勤怠システムからCSVダウンロード | 毎日同じ作業で面倒 | 勤怠システム | 自動ダウンロード |
| 9:05 | **Excelで「CSV読込」ボタンクリック** | **ボタン1つで楽！** | **本システム** | - |
| 9:06 | 未入力者リストを確認 | 今日は3名か、少ないな | 本システム | - |
| 9:07 | **「管理者通知」ボタンクリック** | **送信も簡単！** | **本システム** | - |
| 9:08 | 他の業務に移る | 5分で終わった、時間が浮いた😊 | - | - |
| 17:00 | 通知履歴を確認 | ちゃんと送信できてる、安心 | 本システム | - |

**改善前の所要時間**: 15分
**改善後の所要時間**: 3分
**削減時間**: 12分/日 = 約4時間/月

---

## 技術的ストーリー（テクニカルデット対策）

### Tech Story 1: VBAコードのモジュール分割

**ストーリー**:
```
開発者として、
VBAコードを機能別にモジュール分割したい
なぜなら、保守性と可読性を向上させたいから
```

**受入基準**:
- [ ] Setup、Import、Notification、Masterの4モジュールに分割
- [ ] 各モジュールは単一責任原則に従う
- [ ] モジュール間の依存関係を最小化
- [ ] 各関数にコメントを記載

**優先度**: ⚠️ 高
**見積もり**: 3 Story Points

---

### Tech Story 2: エラーハンドリングの標準化

**ストーリー**:
```
開発者として、
すべての関数に統一されたエラーハンドリングを実装したい
なぜなら、予期しないエラーでシステムが停止するのを防ぎたいから
```

**受入基準**:
- [ ] すべての関数に On Error GoTo を実装
- [ ] エラーメッセージに具体的な対処方法を含む
- [ ] エラーログをDebug.Printで出力
- [ ] ユーザーフレンドリーなエラーダイアログ

**優先度**: ⚠️ 高
**見積もり**: 2 Story Points

---

### Tech Story 3: 自動テストの導入

**ストーリー**:
```
開発者として、
主要機能の自動テストを作成したい
なぜなら、リファクタリング時の品質を担保したいから
```

**受入基準**:
- [ ] CSV読込のユニットテスト
- [ ] 未入力者抽出のテストケース
- [ ] Webhook送信のモックテスト
- [ ] 回帰テストスイートの作成

**優先度**: 📋 低
**見積もり**: 5 Story Points
**実装フェーズ**: Phase 4

---

## ストーリーポイント集計

| Epic | Story数 | 合計SP | 優先度分布 |
|------|---------|--------|-----------|
| Epic 1: CSV管理 | 2 | 5 SP | 🔥×1, ⚠️×1 |
| Epic 2: 通知管理 | 3 | 15 SP | 🔥×1, ⚠️×1, 📅×1 |
| Epic 3: 社員マスタ | 2 | 5 SP | ⚠️×1, 📅×1 |
| Epic 4: 運用・保守 | 2 | 5 SP | ⚠️×1, 📋×1 |
| 技術的ストーリー | 3 | 10 SP | ⚠️×2, 📋×1 |
| **合計** | **12** | **40 SP** | - |

---

## スプリント計画

### スプリント1（Phase 1）- MVP実装

**期間**: 2025/10/18-25（1週間）
**目標**: 管理者通知の基本機能完成

**含まれるストーリー**:
- ✅ Story 1.1: CSV読込機能（3 SP）
- ✅ Story 2.1: 管理者チャンネル通知（5 SP）
- ✅ Story 2.3: 通知履歴管理（2 SP）
- Tech Story 1: モジュール分割（3 SP）

**合計**: 13 SP
**デモ**: 2025/10/25

---

### スプリント2（Phase 2）- マスタ管理

**期間**: 2025/10/26-11/05（1.5週間）
**目標**: 社員マスタ整備と個別通知準備

**含まれるストーリー**:
- Story 1.2: データ検証機能（2 SP）
- Story 3.1: 社員マスタ自動登録（3 SP）
- Story 3.2: 社員マスタ手動更新（2 SP）
- Story 4.1: エラー対応ガイド（3 SP）
- Tech Story 2: エラーハンドリング（2 SP）

**合計**: 12 SP
**デモ**: 2025/11/05

---

### スプリント3（Phase 3）- 個別通知

**期間**: 2025/11/06-20（2週間）
**目標**: Bot API統合と個別トーク送信

**含まれるストーリー**:
- Story 2.2: 個別トーク通知（8 SP）
- Story 4.2: パフォーマンス監視（2 SP）

**合計**: 10 SP
**デモ**: 2025/11/20

---

### スプリント4（Phase 4）- 品質向上

**期間**: 2025/11/21-30（1.5週間）
**目標**: テスト・ドキュメント・最適化

**含まれるストーリー**:
- Tech Story 3: 自動テスト（5 SP）
- その他の改善（バッファ）

**合計**: 5 SP

---

## 変更管理

このドキュメントは、ステークホルダーのフィードバックに基づいて随時更新されます。

**更新履歴**:
| 日付 | 変更内容 | 変更者 |
|------|---------|--------|
| 2025/10/17 | 初版作成 | [担当者名] |

